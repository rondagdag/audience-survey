name: Deploy to Azure Container Apps and Test

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  ARM_USE_OIDC: true

jobs:
  build_and_deploy:
    name: Build, push image, update app
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://audsurvey-app-l56h90.thankfulwater-714ba05a.westus.azurecontainerapps.io
    env:
      ACR_LOGIN_SERVER: audsurveyacrl56h90.azurecr.io
      CONTAINER_APP_NAME: audsurvey-app-l56h90
      RESOURCE_GROUP_NAME: rg-audience-survey
      KEY_VAULT_NAME: audsurvey-kv-l56h90
      STORAGE_ACCOUNT_NAME: audsurveyl56h90
      PROJECT_NAME: audsurvey
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Azure CLI - Login to ACR
        run: |
          ACR_NAME="${ACR_LOGIN_SERVER%%.*}"
          az acr login --name "$ACR_NAME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image for AMD64
        working-directory: app
        run: |
          IMAGE="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:${{ github.sha }}"
          IMAGE_LATEST="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:latest"
          echo "Building $IMAGE for linux/amd64"
          docker buildx build --platform linux/amd64 -t "$IMAGE" -t "$IMAGE_LATEST" --push .
          echo "Waiting 30 seconds for image to propagate..."
          sleep 30

      - name: Get secrets from Key Vault
        id: get_secrets
        run: |
          AZURE_CONTENT_ENDPOINT=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name azure-content-endpoint --query value -o tsv)
          AZURE_CONTENT_KEY=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name azure-content-key --query value -o tsv)
          ADMIN_SECRET=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name admin-secret --query value -o tsv)
          echo "::add-mask::$AZURE_CONTENT_KEY"
          echo "::add-mask::$ADMIN_SECRET"
          echo "azure_content_endpoint=$AZURE_CONTENT_ENDPOINT" >> $GITHUB_OUTPUT
          echo "azure_content_key=$AZURE_CONTENT_KEY" >> $GITHUB_OUTPUT
          echo "admin_secret=$ADMIN_SECRET" >> $GITHUB_OUTPUT

      - name: Update Container App with new image
        run: |
          IMAGE="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:${{ github.sha }}"
          
          # Get the Container App's managed identity client ID
          echo "Fetching managed identity..."
          MANAGED_IDENTITY_CLIENT_ID=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query "identity.userAssignedIdentities.*.clientId | [0]" -o tsv)
          
          if [ -z "$MANAGED_IDENTITY_CLIENT_ID" ]; then
            echo "Warning: No managed identity found, proceeding without AZURE_CLIENT_ID"
          else
            echo "Using managed identity: $MANAGED_IDENTITY_CLIENT_ID"
          fi
          
          echo "Updating Container App with image: $IMAGE"
          
          # Update the container image and environment variables with retry logic
          for i in 1 2 3; do
            echo "Attempt $i of 3..."
            if az containerapp update \
              --name $CONTAINER_APP_NAME \
              --resource-group $RESOURCE_GROUP_NAME \
              --image "$IMAGE" \
              --set-env-vars \
                NODE_ENV=production \
                AZURE_CONTENT_ENDPOINT="${{ steps.get_secrets.outputs.azure_content_endpoint }}" \
                AZURE_CONTENT_KEY="${{ steps.get_secrets.outputs.azure_content_key }}" \
                AZURE_ANALYZER_ID=audience-survey \
                AZURE_STORAGE_ACCOUNT_NAME=$STORAGE_ACCOUNT_NAME \
                AZURE_STORAGE_CONTAINER_NAME=uploads \
                AZURE_CLIENT_ID=$MANAGED_IDENTITY_CLIENT_ID \
                ADMIN_SECRET="${{ steps.get_secrets.outputs.admin_secret }}" \
                PORT=3000 \
                NEXT_TELEMETRY_DISABLED=1; then
              echo "Container app updated successfully"
              break
            else
              if [ $i -eq 3 ]; then
                echo "Failed to update container app after 3 attempts"
                exit 1
              fi
              echo "Update failed, waiting 30 seconds before retry..."
              sleep 30
            fi
          done