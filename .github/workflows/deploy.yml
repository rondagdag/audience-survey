name: Deploy to Azure Container Apps and Test

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  ARM_USE_OIDC: true

jobs:
  build_and_deploy:
    name: Build, push image, update app
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://audsurvey-app-l56h90.thankfulwater-714ba05a.westus.azurecontainerapps.io
    env:
      ACR_LOGIN_SERVER: audsurveyacrl56h90.azurecr.io
      CONTAINER_APP_NAME: audsurvey-app-l56h90
      RESOURCE_GROUP_NAME: rg-audience-survey
      KEY_VAULT_NAME: audsurvey-kv-l56h90
      STORAGE_ACCOUNT_NAME: audsurveyl56h90
      PROJECT_NAME: audsurvey
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Azure CLI - Login to ACR
        run: |
          ACR_NAME="${ACR_LOGIN_SERVER%%.*}"
          az acr login --name "$ACR_NAME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image for AMD64
        working-directory: app
        run: |
          IMAGE="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:${{ github.sha }}"
          IMAGE_LATEST="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:latest"
          echo "Building $IMAGE for linux/amd64"
          docker buildx build --platform linux/amd64 -t "$IMAGE" -t "$IMAGE_LATEST" --push .

      - name: Get secrets from Key Vault
        id: get_secrets
        run: |
          AZURE_CONTENT_ENDPOINT=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name azure-content-endpoint --query value -o tsv)
          AZURE_CONTENT_KEY=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name azure-content-key --query value -o tsv)
          ADMIN_SECRET=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name admin-secret --query value -o tsv)
          echo "::add-mask::$AZURE_CONTENT_KEY"
          echo "::add-mask::$ADMIN_SECRET"
          echo "azure_content_endpoint=$AZURE_CONTENT_ENDPOINT" >> $GITHUB_OUTPUT
          echo "azure_content_key=$AZURE_CONTENT_KEY" >> $GITHUB_OUTPUT
          echo "admin_secret=$ADMIN_SECRET" >> $GITHUB_OUTPUT

      - name: Update Container App with new image
        run: |
          IMAGE="$ACR_LOGIN_SERVER/$PROJECT_NAME/web:${{ github.sha }}"
          
          # Get the Container App's managed identity client ID
          MANAGED_IDENTITY_CLIENT_ID=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query "identity.userAssignedIdentities.*.clientId | [0]" -o tsv)
          
          # Update the container image and secrets
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --image "$IMAGE" \
            --set-env-vars \
              AZURE_CONTENT_ENDPOINT="${{ steps.get_secrets.outputs.azure_content_endpoint }}" \
              AZURE_CONTENT_KEY="${{ steps.get_secrets.outputs.azure_content_key }}" \
              AZURE_ANALYZER_ID=audience-survey \
              AZURE_STORAGE_ACCOUNT_NAME=$STORAGE_ACCOUNT_NAME \
              AZURE_STORAGE_CONTAINER_NAME=uploads \
              AZURE_CLIENT_ID=$MANAGED_IDENTITY_CLIENT_ID \
              ADMIN_SECRET="${{ steps.get_secrets.outputs.admin_secret }}" \
              PORT=3000

  e2e_tests:
    name: Run Playwright tests against deployed app
    runs-on: ubuntu-latest
    needs: build_and_deploy
    container:
      image: mcr.microsoft.com/playwright:v1.49.0-jammy
    env:
      KEY_VAULT_NAME: audsurvey-kv-l56h90
      CONTAINER_APP_URL: https://audsurvey-app-l56h90.thankfulwater-714ba05a.westus.azurecontainerapps.io
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get admin secret from Key Vault
        id: admin_secret
        run: |
          ADMIN_SECRET=$(az keyvault secret show --vault-name $KEY_VAULT_NAME --name admin-secret --query value -o tsv)
          echo "::add-mask::$ADMIN_SECRET"
          echo "admin_secret=$ADMIN_SECRET" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Wait for Container App to be ready
        run: |
          echo "Waiting 30 seconds for Container App to stabilize after update..."
          sleep 30

      - name: Run tests
        working-directory: app
        env:
          E2E_BASE_URL: ${{ env.CONTAINER_APP_URL }}
          ADMIN_SECRET: ${{ steps.admin_secret.outputs.admin_secret }}
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: app/playwright-report
